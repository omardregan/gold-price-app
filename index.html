<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>حاسبة الذهب والفضة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial; direction: rtl; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    .input-group { margin-bottom: 15px; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; font-size: 16px; }
    .result { margin-top: 20px; font-size: 18px; color: green; text-align: center; }
    .prices { text-align: center; margin-bottom: 20px; font-size: 18px; color: #333; }
  </style>
</head>
<body>
  <h1>حاسبة الذهب والفضة</h1>
  <div class="prices">
    <p>سعر جرام الذهب الآن: <span id="goldPrice">جارٍ التحميل...</span> درهم</p>
    <p>سعر جرام الفضة الآن: <span id="silverPrice">جارٍ التحميل...</span> درهم</p>
    <p style="font-size: 14px; color: #666;">آخر تحديث: <span id="lastUpdate">جارٍ التحميل...</span></p>
  </div>

  <div class="input-group">
    <label>النوع:</label>
    <select id="metalType">
      <option value="gold">ذهب</option>
      <option value="silver">فضة</option>
    </select>
  </div>

  <div class="input-group">
    <label>عدد الجرامات:</label>
    <input type="number" id="grams" placeholder="أدخل عدد الجرامات" />
  </div>

  <button onclick="calculatePrice()">احسب السعر</button>

  <div class="result" id="resultText"></div>

  <script>
    let prices = { gold:0, silver:0 };

    async function fetchUsdToAed() {
      const resp = await fetch('https://open.er-api.com/v6/latest/USD');
      const data = await resp.json();
      return data.rates['AED'];
    }

    async function fetchPrices() {
      try {
        const usd2aed = await fetchUsdToAed();

        const [gd, sd] = await Promise.all([
          fetch("https://www.goldapi.io/api/XAU/USD", {
            headers: {
              "x-access-token": "goldapi-1qe0smchzu8n0-io",
              "Content-Type": "application/json"
            }
          }).then(r=>r.json()),
          fetch("https://www.goldapi.io/api/XAG/USD", {
            headers: {
              "x-access-token": "goldapi-1qe0smchzu8n0-io",
              "Content-Type": "application/json"
            }
          }).then(r=>r.json())
        ]);

        if(gd.price && sd.price && usd2aed) {
          const perGram = o => o/31.1035;
          prices.gold = perGram(gd.price)*usd2aed;
          prices.silver = perGram(sd.price)*usd2aed;

          document.getElementById("goldPrice").textContent = prices.gold.toFixed(2);
          document.getElementById("silverPrice").textContent = prices.silver.toFixed(2);

          // التاريخ من GoldAPI بصيغة Unix Timestamp
          const updated = new Date(gd.timestamp * 1000);
          const options = { timeZone: 'Asia/Dubai', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' };
          const formattedDate = updated.toLocaleString('ar-EG', options);

          document.getElementById("lastUpdate").textContent = formattedDate;
        } else throw Error();
      } catch(e) {
        document.getElementById("goldPrice").textContent = "خطأ في جلب السعر";
        document.getElementById("silverPrice").textContent = "خطأ في جلب السعر";
        document.getElementById("lastUpdate").textContent = "غير متوفر";
        console.error(e);
      }
    }

    function calculatePrice() {
      const g = parseFloat(document.getElementById("grams").value);
      const m = document.getElementById("metalType").value;
      const p = prices[m];
      if(isNaN(g)||g<=0) {
        return document.getElementById("resultText").textContent = "أدخل عدد جرامات صحيح";
      }
      if(p===0) {
        return document.getElementById("resultText").textContent = "السعر لم يُحمّل بعد، انتظر لحظة";
      }
      document.getElementById("resultText").textContent =
        `السعر الإجمالي: ${(g*p).toFixed(2)} درهم`;
    }

    fetchPrices();
  </script>
</body>
</html>
