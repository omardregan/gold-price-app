<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>حاسبة الذهب والفضة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .input-group {
      margin-bottom: 15px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 16px;
    }
    .result {
      margin-top: 20px;
      font-size: 18px;
      color: green;
      text-align: center;
    }
    .prices {
      text-align: center;
      margin-bottom: 20px;
      font-size: 18px;
      color: #333;
    }
    .note {
      font-size: 14px;
      text-align: center;
      color: #777;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <h1>حاسبة الذهب والفضة</h1>

  <div class="prices">
    <p>سعر جرام الذهب الآن: <span id="goldPrice">جارٍ التحميل...</span> درهم
      <span style="font-size: 14px; color: #777;">عيار 24 (999.9)</span>
    </p>
    <p>سعر جرام الفضة الآن: <span id="silverPrice">جارٍ التحميل...</span> درهم
      <span style="font-size: 14px; color: #777;">نقاء 99.9% (999)</span>
    </p>
    <p style="font-size: 14px; color: #666;">
      آخر تحديث: <span id="lastUpdate">جارٍ التحميل...</span>
    </p>
  </div>

  <div class="input-group">
    <label>النوع:</label>
    <select id="metalType">
      <option value="gold">ذهب</option>
      <option value="silver">فضة</option>
    </select>
  </div>

  <div class="input-group">
    <label>عدد الجرامات:</label>
    <input type="number" id="grams" placeholder="أدخل عدد الجرامات" />
  </div>

  <button onclick="calculatePrice()">احسب السعر</button>

  <div class="result" id="resultText"></div>

  <div class="note">
    الأسعار تعتمد على السوق العالمي، وتُحسب بالدرهم الإماراتي تلقائيًا.<br/>
    الأسعار لا تشمل مصنعية أو ضريبة القيمة المضافة.
  </div>

  <script>
    let prices = { gold: 0, silver: 0 };

    async function fetchUsdToAed() {
      const resp = await fetch('https://open.er-api.com/v6/latest/USD');
      const data = await resp.json();
      return data.rates['AED'];
    }

    async function fetchPrices() {
      try {
        const usd2aed = await fetchUsdToAed();

        const [gd, sd] = await Promise.all([
          fetch("https://www.goldapi.io/api/XAU/USD", {
            headers: {
              "x-access-token": "goldapi-1qe0smchzu8n0-io",
              "Content-Type": "application/json"
            }
          }).then(r => r.json()),
          fetch("https://www.goldapi.io/api/XAG/USD", {
            headers: {
              "x-access-token": "goldapi-1qe0smchzu8n0-io",
              "Content-Type": "application/json"
            }
          }).then(r => r.json())
        ]);

        if (gd.price && sd.price && usd2aed) {
          const perGram = o => o / 31.1035;
          prices.gold = perGram(gd.price) * usd2aed;
          prices.silver = perGram(sd.price) * usd2aed;

          document.getElementById("goldPrice").textContent = prices.gold.toFixed(2);
          document.getElementById("silverPrice").textContent = prices.silver.toFixed(2);

          const updated = new Date(gd.timestamp * 1000);
          const options = { timeZone: 'Asia/Dubai', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
          const formattedDate = updated.toLocaleString('ar-EG', options);
          document.getElementById("lastUpdate").textContent = formattedDate;
        } else {
          throw Error("بيانات غير مكتملة من API");
        }
      } catch (e) {
        document.getElementById("goldPrice").textContent = "خطأ في جلب السعر";
        document.getElementById("silverPrice").textContent = "خطأ في جلب السعر";
        document.getElementById("lastUpdate").textContent = "غير متوفر";
        console.error(e);
      }
    }

    function calculatePrice() {
      const grams = parseFloat(document.getElementById("grams").value);
      const metal = document.getElementById("metalType").value;
      const pricePerGram = prices[metal];

      if (isNaN(grams) || grams <= 0) {
        document.getElementById("resultText").textContent = "يرجى إدخال عدد صحيح للجرامات.";
        return;
      }

      if (pricePerGram === 0) {
        document.getElementById("resultText").textContent = "السعر لم يُحمّل بعد، يرجى الانتظار.";
        return;
      }

      const total = grams * pricePerGram;
      document.getElementById("resultText").textContent = `السعر الإجمالي: ${total.toFixed(2)} درهم`;
    }

    fetchPrices();
  </script>
</body>
</html>
